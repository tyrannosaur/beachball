var box2dw={};(function(a){var b=Box2D.Common.Math.b2Vec2,c=Box2D.Collision.b2AABB,d=Box2D.Dynamics.b2BodyDef,e=Box2D.Dynamics.b2Body,f=Box2D.Dynamics.b2FixtureDef,g=Box2D.Dynamics.b2Fixture,h=Box2D.Dynamics.b2World,i=Box2D.Collision.Shapes.b2MassData,j=Box2D.Collision.Shapes.b2PolygonShape,k=Box2D.Collision.Shapes.b2CircleShape;ContactListener=Box2D.Dynamics.b2ContactListener;var l=function(a,b){$.each(a,function(c,d){if(a.hasOwnProperty(c)&&!(c in b))b[c]=a[c];});return b;};box2dw.px2m=function(a,b){if(typeof a=='string')return parseFloat(a.replace(/^\s*([-0-9.]+)\s*px/im,function(a,c){return parseFloat(c)*1/b;}));else return a;};function m(a){l({ignoreStatic:true,drawScale:1.0,gravity:{x:0,y:9.8}},a);this.bodies=[];this.drawScale=a.drawScale;this.world=new h(new b(a.gravity.x,a.gravity.y),a.ignoreStatic);var c=new Box2D.Dynamics.b2ContactListener();c.BeginContact=function(a){if(typeof a.m_fixtureA.m_body.sensorCallback==='function')a.m_fixtureA.m_body.sensorCallback.call(null,a,a.m_fixtureA.m_body,a.m_fixtureB.m_body);if(typeof a.m_fixtureB.m_body.sensorCallback==='function')a.m_fixtureB.m_body.sensorCallback.call(null,a,a.m_fixtureB.m_body,a.m_fixtureA.m_body);};this.world.SetContactListener(c);};m.prototype.randomImpulse=function(a,c){l({minAngle:0,maxAngle:360,scale:'10px'},c);c.scale=this.parsePixels(c.scale);var d=c.minAngle+Math.random()*(c.maxAngle-c.minAngle);var e=a.GetWorldCenter();var f=new b(Math.cos(d*Math.PI/180)*c.scale,Math.sin(d*Math.PI/180)*c.scale);a.ApplyImpulse(f,e);};m.prototype.parsePixels=function(a){return box2dw.px2m(a,this.drawScale);};m.prototype.toPixels=function(a){return a*this.drawScale;};m.prototype.toMeters=function(a){if(typeof a=='string')a=a.replace(/px/i,'');return a/this.drawScale;};m.prototype.gravity=function(a){var c=this.world.GetGravity();if(!a)return c;else this.world.SetGravity(new b(a.x==undefined?c.x:a.x,a.y==undefined?c.y:a.y));};m.prototype.body=function(a){if(arguments.length===0)throw new TypeError();l({'shape':'box','static':true,'density':1.0,'friction':0.5,'restitution':0.3,'sensorCallback':undefined,'x':0,'y':0,'rotation':0,'radius':0.1,'width':0.1,'height':0.1,'scaleX':1,'scaleY':1,'scale':1,'vertices':undefined,'id':undefined},a);a=l(a,{'x':this.parsePixels(a.x),'y':this.parsePixels(a.y),'radius':this.parsePixels(a.radius),'width':this.parsePixels(a.width),'height':this.parsePixels(a.height)});if(a.vertices)a.shape='polygon';if(a.scale){a.scaleX=a.scale;a.scaleY=a.scale;}var c=new f();var g=new d();c.density=a.density;c.friction=a.friction;c.restitution=a.restitution;g.type=a.static?e.b2_staticBody:e.b2_dynamicBody;g.position.Set(a.x,a.y);switch(a.shape){case 'box':c.shape=new j();c.shape.SetAsBox(a.scaleX*a.width/2,a.scaleY*a.height/2);break;case 'polygon':var h=this;var i=$.map(a.vertices,function(c,d){return new b(a.scaleX*h.parsePixels(c[0]),a.scaleY*h.parsePixels(c[1]));});c.shape=new j();c.shape.SetAsArray(i,i.length);break;case 'circle':c.shape=new k(a.scaleX*a.radius);break;default:throw new TypeError();}var m=this.world.CreateBody(g);var n=m.CreateFixture(c);if(typeof a.sensorCallback==='function')m.sensorCallback=a.sensorCallback;m.SetAngle(a.rotation);m.id=a.id;this.bodies.push(m);return m;};box2dw.world=function(a){return new m(a||{});};})(this);