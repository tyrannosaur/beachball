(function(e){function b(e,t,n){e.ApplyImpulse({x:Math.cos(t)*n,y:Math.sin(t)*n},e.GetWorldCenter())}function w(){o.SetAngularVelocity(0),o.SetLinearVelocity({x:0,y:0}),o.SetPositionAndAngle({x:n.toMeters(s.x),y:n.toMeters(s.y)},0),b(o,2*Math.PI*Math.random(),u)}function E(e,t,r){var i;t.id=="#beachball"?i=t:r.id=="#beachball"&&(i=r),i&&y.emit({type:"lost",body:i,drawRatio:n.drawRatio()})}var t=e.repeater=function(e,t){function o(){return n!=undefined}if(e.delay<=0)throw Error("delay must be greater than zero");if(typeof t!="function")throw Error();var n,r=e.onStart,i=e.onStop,s=e.delay;return{start:function(){o()||(n=setInterval(t,1e3*s),typeof r=="function"&&r())},stop:function(){o()&&(n=clearInterval(n),typeof i=="function"&&i())},running:o}},n,r,i,s,o,u=1e-4,a,f,l=1,c=.01,h=[],p=[],d,v,m=!1,g={},y=$({});e.game=g,y.emit=y.triggerHandler,v=t({delay:1/r},function(){n.step(1/r,i,i),n.iterBodies(function(e,t){if(t.id!=undefined){var r=t.GetPosition(),i=t.GetAngle(),s=n.drawRatio(),o=$(t.id);o.css("left",r.x*s-o.width()/2+"px"),o.css("top",r.y*s-o.height()/2+"px"),o.rotate(i,"rad")}}),n.clearForces()}),f=t({delay:c},function(){var e=0,t=0;for(var r in h)e+=h[r];for(var r in p)t+=p[r];e/=h.length,t/=p.length,h=[],p=[],e*=l,t*=l,!isNaN(e)&&!isNaN(t)&&(console.log(e,t),n.gravity({x:e,y:-t}),b(o,Math.asin(e/Math.sqrt(Math.pow(e,2)+Math.pow(t,2))),u))}),g.events=y,g.resetBeachball=w,g.load=function(e){a=e.gravity||{x:0*l,y:9.8*l},r=e.fps>0?e.fps:30,i=e.step>0?e.step:4,g.difficulty(e.difficulty||"hard");var t=$(window),u=t.width(),c=t.height();$("#beach-fg").css("left",u/2-$("#beach-fg").width()/2+"px"),$("#beach-bg").css("left",u/2-$("#beach-bg").width()/2+"px");var d=$("#beach-bg"),v=$("#beachball"),m=d.offset().top,b=d.offset().left,w=d.width(),S=d.height(),x=d.cornerRadius(),T=Math.max(v.width(),v.height())/2;n=new Box2D.world({drawRatio:u,gravity:a}),v.css("left",u/2-v.width()/2+"px"),s={x:v.offset().left,y:v.offset().top};var N=10,C=T*2,k=[{width:2*C+u,height:N,x:u/2,y:-C-N},{width:N,height:2*C+c,x:u+C,y:c/2},{width:2*C+u,height:N,x:u/2,y:c+C},{width:N,height:2*C+c,x:u+C,y:c/2}];$.each(k,function(e,t){n.addBody({"static":!0,sensorCallback:E,x:t.x+"px",y:t.y+"px",width:t.width+"px",height:t.height+"px"})}),n.addBody({shape:"box",x:u/2+"px",y:m+S/2+"px",width:w-2*x+"px",height:S+"px"}),n.addBody({shape:"circle",x:b+x+"px",y:m+S/2+"px",radius:x+"px"}),n.addBody({shape:"circle",x:b+w-x+"px",y:m+S/2+"px",radius:x+"px"}),o=n.addBody({shape:"circle","static":!1,radius:T+"px",x:s.x+"px",y:s.y+"px",id:"#beachball"}),t.on("devicemotion",function(e){e=e.originalEvent;switch(window.orientation){case 90:h.push(-e.accelerationIncludingGravity.y),p.push(e.accelerationIncludingGravity.x);break;case-90:h.push(e.accelerationIncludingGravity.y),p.push(-e.accelerationIncludingGravity.x);break;default:h.push(e.accelerationIncludingGravity.x),p.push(e.accelerationIncludingGravity.y)}}),f.start(),y.emit({type:"loaded.core",settings:e})},g.pushBeachball=function(e){var t=n.gravity(),r=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)),i=u*(1+Math.random());switch(e){case"left":b(o,Math.acos(-t.y/r),i);break;case"right":b(o,Math.acos(t.y/r),i);break;case"gravity":h.push(arguments[1]),p.push(arguments[2])}},g.start=function(){v.start(),m=!0},g.stop=function(){m=!1,v.stop()},g.restart=function(){g.stop(),w(),g.start()},g.started=function(){return m},g.difficulty=function(e){if(!e)return d;switch(e){case"hard":l=1.25,impulseMagnitude=.01,d=e;break;case"normal":l=1,impulseMagnitude=.001,d=e;break;case"easy":l=.5,impulseMagnitude=1e-4,d=e}}})(this)
